<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="9/80 schedule with semi-monthly payroll">
    <title>BigBeat.io: 9/80 Schedule</title>
    <style>
        /* colors shared across dark and light mode */
        :root {
            --weekend-background-color: #4db6ac;
            --off-friday-background-color: #5599bb;
        }

        :root[data-theme='light'] {
            --color: #000;
            --background-color: #fff;
            --days-color: #fff;
            --days-background-color: #444;
            --holiday-background-color: #ffcc55;
            --context-color: var(--days-color);
            --context-background-color: #f0f0f0;
            --github-ribbon-color: #fff;
            --github-ribbon-background-color: #121621;
        }

        :root[data-theme='dark'] {
            --color: #fff;
            --background-color: #222;
            --days-color: #ddd;
            --days-background-color: #555;
            --holiday-background-color: #c49321;
            --context-color: #666;
            --context-background-color: #191919;
            --github-ribbon-color: #000;
            --github-ribbon-background-color: #ccc;
        }
        :root[data-theme="light"] .light-hidden {
            display: none;
        }

        :root[data-theme="dark"] .dark-hidden {
            display: none;
        }

        body {
            background-color: var(--background-color);
            color: var(--color);
            font-family: monospace;
            margin: 0;
            transition: color .2s ease-in, background-color .2s ease-in;
        }

        header {
            display: flex;
            margin: .2em;
            margin-bottom: .8em;
        }

        header .left, header .right {
            flex-grow: 1;
        }

        header .center {
            margin-top: auto;
            margin-bottom: auto;
        }

        #theme-toggle {
            display: inline-block;
        }

        header .icon {
            height: 1.5em;
            width: 1.5em;
            cursor: pointer;
            filter: brightness(80%);
            filter: opacity(80%);
        }
        header .icon:hover {
            filter: opacity(100%);
            filter: brightness(100%);
        }

        #moon {
            width: 1.5em;
            height: 1.5em;
        }

        #app-container {
            display: flex;
            justify-content: center;
        }

        #app {
        }

        .pay-period {
            padding-bottom: 2em;
        }

        .summary {
            margin-bottom: .4em;
        }

        .daysContainer {
            cursor: default;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-gap: 10px;
            background-color: var(--background-color);
            transition: color .2s ease-in, background-color .2s ease-in;
        }

        .month {
            font-size: 150%;
        }

        .pay-period:not(:first-child) .month {
            margin-top: 1em;
        }

        .day {
            color: var(--days-color);
            background-color: var(--days-background-color);
            border-radius: 5px;
            text-align: center;
            font-size: 150%;
            padding: .4em;
            transition: color .2s ease-in, background-color .2s ease-in;
        }

        @media (min-width: 600px) {
            .day  {
              padding: 1em;
            }
        }

        .today {
            font-weight: bold;
        }

        .weekend {
            background-color: var(--weekend-background-color);
            transition: color .2s ease-in, background-color .2s ease-in;
        }

        .off-friday {
            background-color: var(--off-friday-background-color);
            transition: color .2s ease-in, background-color .2s ease-in;
        }

        .holiday {
            background-color: var(--holiday-background-color);
            transition: color .2s ease-in, background-color .2s ease-in;
        }

        .context {
            color: var(--context-color);
            background-color: var(--context-background-color);
            transition: color .2s ease-in, background-color .2s ease-in;
        }

        @media (max-width: 600px) {
            .github-ribbon {
                display: none;
            }
        }

        .month {
            text-decoration: underline;
            margin-bottom: .1em;
        }

        .stat-name {
            font-weight: bold;
        }

        .high-hours {
            color: red;
        }
    </style>

    <script>
        var storedTheme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        if (storedTheme) {
            document.documentElement.setAttribute("data-theme", storedTheme)
        }
    </script>
  </head>
  <body>
    <noscript>
      <strong>Sadly this site uses javascript :D</strong>
    </noscript>

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="moon">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </symbol>
        <symbol viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="sun">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </symbol>
    </svg>

    <div class="github-ribbon" style="position: absolute; right: 0px; top: 0px; width: 150px; height: 150px; overflow: hidden; z-index: 99999;"><a target="_blank" style="display: inline-block; width: 200px; overflow: hidden; padding: 6px 0px; text-align: center; transform: rotate(45deg); text-decoration: none; color: var(--github-ribbon-color); position: inherit; top: 45px; right: -40px; font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; box-shadow: rgba(0, 0, 0, 0.5) 0px 2px 3px 0px; background-color: var(--github-ribbon-background-color); background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));" href="https://github.com/big-beat/bigbeat.io.git">Fork me on GitHub</a></div></a></div>

    <header>
        <span class="left">
            <span aria-hidden="true" id="theme-toggle">
                <svg class="icon light-hidden">
                    <title>Light Mode</title>
                    <use href="#sun"></use>
                </svg>
                <svg class="icon dark-hidden">
                    <title>Dark Mode</title>
                    <use href="#moon"></use>
                </svg>
            </span>
        </span>
        <span class="center">9/80 schedule + semi-monthly payroll</span>
        <span class="right">
        </span>
    </header>

    <div id="app-container">
        <div id="app"></div>
    </div>
<script>
var toggle = document.getElementById("theme-toggle");
toggle.onclick = function() {
    var currentTheme = document.documentElement.getAttribute("data-theme");
    var targetTheme = "light";
    if (currentTheme === "light") {
        targetTheme = "dark";
    }
    document.documentElement.setAttribute("data-theme", targetTheme)
    localStorage.setItem("theme", targetTheme);
};

// Date
Date.prototype.copy = function() {
    return new Date(this.valueOf());
}

Date.prototype.advance = function(days = 1) {
    this.setDate(this.getDate() + days);
    return this;
}

Date.prototype.nextDay = function() {
    return this.copy().advance();
}

Date.prototype.daysUntil = function(d) {
    const oneDay = 1000 * 60 * 60 * 24
    return Math.round(Math.abs(this - d) / oneDay);
}

Date.prototype.equals = function(d) {
    return this.toDateString() === d.toDateString();
}

// Sunday = 0, Monday = 1, ... Saturday = 6
Date.prototype.toNextDay = function(day) {
    const newDay = this.copy();
    newDay.setDate(newDay.getDate() + (7 + day - newDay.getDay()) % 7);  // TIL: modulo in javascript keeps negative numbers...
    return newDay;
}

Date.prototype.toPrevDay = function(day) {
    const newDay = this.copy();
    const offset = 7 - day;
    newDay.setDate(newDay.getDate() - (newDay.getDay() + offset) % 7);
    return newDay;
}

Date.prototype.nextFriday = function() {
    return this.toNextDay(5);
}

Date.prototype.nextSunday = function() {
    return this.toNextDay(0);
}

Date.prototype.prevMonday = function() {
    return this.toPrevDay(1);
}


// Models
function Payroll(middleDate) {
    this.middleDate = middleDate,
    this.start = this._start(),
    this.end = this._end()
}

Payroll.prototype._start = function() {
    const d = this.middleDate;
    const year = d.getFullYear();
    const month = d.getMonth();
    const day = d.getDate();
    const start = day < 16 ? 1 : 16;
    return new Date(year, month, start);
}

Payroll.prototype._end = function() {
    const d = this.middleDate;
    const year = d.getFullYear();
    const month = d.getMonth();
    const day = d.getDate();

    const end = day < 16 ?
            new Date(year, month, 15) :
            new Date(year, month+1, 0);
    return end;
}

Payroll.prototype.nextPayroll = function() {
    return new Payroll(this.end.nextDay());
}

Payroll.prototype.stats = function() {
    const stats = {
        hours: 0,
        days: 0,
    };
    let i = this.start.copy();
    while (i <= this.end) {
        if (i.getDay() > 0 && i.getDay() < 6 && !isHoliday(i)) {
            stats.hours += 8;
            if (!isObservedOffFriday(i)) {
                stats.days += 1;
            }
        }
        i.advance();
    }
    return stats;
}

const holidays = new Set([
    new Date(2021, 0, 1),
    new Date(2021, 0, 18),
    new Date(2021, 1, 15),
    new Date(2021, 4, 31),
    new Date(2021, 6, 5),
    new Date(2021, 8, 6),
    new Date(2021, 10, 11),
    new Date(2021, 10, 25),
    new Date(2021, 10, 26),
    new Date(2021, 11, 24),
    new Date(2021, 11, 27),
].map(d => d.toDateString()));

function isHoliday(d) {
    if (holidays.has(d.toDateString())) {
        return true;
    }
    return false;
}

function isObservedOffFriday(d) {
    return (isOffFriday(d) && !isHoliday(d)) || dayBeforeHolidayStreak(d);
}

function dayBeforeHolidayStreak(d) {
    const friday = d.nextFriday();

    // next friday is off friday
    if (!isOffFriday(friday)) {
        return false;
    }

    // all the days leading up to it are holidays
    let i = d.nextDay();
    while (i <= friday) {
        if (!isHoliday(i)) {
            return false;
        }
        i.advance();
    }
    return true;
}

function isOffFriday(d) {
    const anOffFriday = new Date(2021, 1, 19);
    return d.daysUntil(anOffFriday) % 14 === 0;
}

function isToday(d) {
    return d.equals(new Date());
}


// Render
function addDiv(container, className) {
    const newDiv = document.createElement("div");
    newDiv.className = className;
    container.appendChild(newDiv);
    return newDiv;
}

const app = document.getElementById('app');

function period(payroll) {
    const d = document.createElement("div");
    d.className = "date-range";
    d.innerHTML = `<span class="stat-name">Payroll:</span> ${payroll.start.toLocaleDateString("en-US")} &ndash; ${payroll.end.toLocaleDateString("en-US")}`;
    return d;
}

function day(d, payroll) {
    const el = document.createElement("div");
    el.className = "day";

    if (d.getDay() == 0 || d.getDay() == 6) {
        el.classList.add("weekend");
        el.setAttribute("title", "Weekend");
    }

    if (d < payroll.start || d > payroll.end) {
        el.classList.add("context");
    }

    if (isHoliday(d)) {
        el.classList.add("holiday");
        el.setAttribute("title", "Holiday");
    }

    if (isToday(d)) {
        el.classList.add("today");
    }

    if (isObservedOffFriday(d)) {
        el.classList.add("off-friday");
        el.setAttribute("title", "Off-friday");
    }

    el.innerHTML = d.getDate();
    return el;
}

function stats(payroll) {
    const stats = payroll.stats();
    let avgHours = stats.hours / stats.days;
    const highHours = avgHours > 9 ? "high-hours" : "";

    const statsDiv = document.createElement("div");
    statsDiv.className = "stats";

    const daysDiv = document.createElement("div");
    daysDiv.className = "days";
    daysDiv.innerHTML = `<span class="stat-name">Days:</span> ${stats.days}`;
    daysDiv.setAttribute("title", "9/80 days");
    statsDiv.appendChild(daysDiv);

    const hoursDiv = document.createElement("div");
    hoursDiv.className = "hours";
    hoursDiv.innerHTML = `
        <span class="stat-name">Hours:</span>
        <span class="stat-value">
            ${stats.hours} (<span class="${highHours}">${avgHours.toFixed(2)}</span>/day)
        </span>`;
    hoursDiv.setAttribute("title", "Non-holiday hours");
    statsDiv.appendChild(hoursDiv);

    return statsDiv;
}

function drawSummary(root, payroll) {
    const summary = document.createElement("div");
    summary.className = "summary";
    summary.appendChild(period(payroll));
    summary.appendChild(stats(payroll));
    root.appendChild(summary);
};

function drawPayPeriod(root, payroll) {
    const today = new Date();
    const weekStart = payroll.start.prevMonday();
    const weekEnd = payroll.end.nextSunday();

    const payPeriod = document.createElement("div");
    payPeriod.className = "pay-period";
    root.appendChild(payPeriod);

    if (payroll.start.getDate() === 1) {
        const month = addDiv(payPeriod, "month");
        const monthName = payroll.start.toLocaleString("default", {month: "long"});
        month.innerHTML = `${monthName}`;
    }

    drawSummary(payPeriod, payroll);

    const daysContainer = document.createElement("div");
    daysContainer.className = "daysContainer";
    payPeriod.appendChild(daysContainer);

    let i = weekStart.copy();
    while (i <= weekEnd) {
        const d = day(i, payroll);
        daysContainer.appendChild(d);
        i.advance();
    }
}

function drawCurrentPayPeriod(app) {
    let payroll = new Payroll(new Date());
    while (payroll.start.getFullYear() == 2021) {
        drawPayPeriod(app, payroll);
        payroll = payroll.nextPayroll();
    }
}

drawCurrentPayPeriod(app);
    </script>
  </body>
</html>
